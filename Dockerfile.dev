# ==================================================
# Development Dockerfile for OpenAssess
# ==================================================
# This is optimized for development with hot reloading
# Source code is mounted as volumes, not copied into the image
# ==================================================

FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    gnupg \
    gcc \
    git && \
    # Install Node.js 22.x
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends nodejs && \
    # Enable pnpm via corepack
    corepack enable && \
    corepack prepare pnpm@latest --activate && \
    # Cleanup
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 -s /bin/bash appuser

# Copy and install Python dependencies
COPY backend/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# Create directory structure
RUN mkdir -p /app/backend /app/frontend && \
    mkdir -p /app/backend/storage/pdfs/question_papers \
             /app/backend/storage/pdfs/answer_sheets \
             /app/backend/storage/jsons/annotations \
             /app/backend/storage/jsons/submissions

# Copy entrypoint script
COPY docker/entrypoint.dev.sh /entrypoint.dev.sh
RUN chmod +x /entrypoint.dev.sh

# Set ownership
RUN chown -R appuser:appuser /app

# Set environment variables for development
ENV PYTHONPATH=/app/backend \
    NODE_ENV=development \
    PORT=3000 \
    PYTHONUNBUFFERED=1

# Switch to non-root user
USER appuser

# Expose ports
EXPOSE 3000 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1

# Use development entrypoint
ENTRYPOINT ["/entrypoint.dev.sh"]
